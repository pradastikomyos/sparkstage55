{
  "audit": "db",
  "meta": {
    "generated_at": "2026-01-31T08:14:20.52944Z",
    "source_path": "C:\\Users\\prada\\Documents\\Spark studio\\",
    "target_path": "C:\\Users\\prada\\Documents\\sparkstage55\\"
  },
  "source": {
    "supabase": {
      "project_ref": "hogzjapnkvsihvvbgcdb",
      "migrations": [
        "20260127_migrate_user_fk_to_uuid.sql",
        "20260128110450_fix_fk_constraints_and_rls.sql",
        "20260128120000_cleanup_laravel_legacy_tables.sql",
        "20260129_refactor_product_schema.sql",
        "20260130035520_add_product_multi_images.sql"
      ],
      "functions_layout": "supabase/functions/<function_slug>/index.ts"
    }
  },
  "target": {
    "supabase": {
      "migrations_present": false,
      "migrations_path_expected": "supabase/migrations/*.sql",
      "functions_layout": "supabase/<function_slug>/index.ts",
      "functions_layout_expected": "supabase/functions/<function_slug>/index.ts"
    }
  },
  "live_supabase": {
    "project_ref": "hogzjapnkvsihvvbgcdb",
    "project_name": "sparkstage55.office Project",
    "region": "ap-southeast-1",
    "schema_migrations": [
      {
        "version": "20260127",
        "name": "migrate_user_fk_to_uuid"
      },
      {
        "version": "20260128110450",
        "name": "fix_fk_constraints_and_rls"
      },
      {
        "version": "20260128120000",
        "name": "cleanup_laravel_legacy_tables"
      },
      {
        "version": "20260129",
        "name": "refactor_product_schema"
      },
      {
        "version": "20260130035520",
        "name": "add_product_multi_images"
      }
    ],
    "public_tables_summary": [
      {
        "schema": "public",
        "name": "app_configs",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 9,
        "fk_count": 0,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 1
      },
      {
        "schema": "public",
        "name": "categories",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 9,
        "fk_count": 1,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 2
      },
      {
        "schema": "public",
        "name": "discount_products",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 6,
        "fk_count": 3,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 1
      },
      {
        "schema": "public",
        "name": "discounts",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 14,
        "fk_count": 0,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 2
      },
      {
        "schema": "public",
        "name": "order_items",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 10,
        "fk_count": 2,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 1
      },
      {
        "schema": "public",
        "name": "order_product_items",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 11,
        "fk_count": 2,
        "policy_count": 2,
        "trigger_count": 0,
        "index_count": 2
      },
      {
        "schema": "public",
        "name": "order_products",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 25,
        "fk_count": 5,
        "policy_count": 2,
        "trigger_count": 0,
        "index_count": 8
      },
      {
        "schema": "public",
        "name": "orders",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 11,
        "fk_count": 1,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 4
      },
      {
        "schema": "public",
        "name": "payments",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 11,
        "fk_count": 1,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 3
      },
      {
        "schema": "public",
        "name": "product_images",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 7,
        "fk_count": 1,
        "policy_count": 4,
        "trigger_count": 0,
        "index_count": 4
      },
      {
        "schema": "public",
        "name": "product_reviews",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 11,
        "fk_count": 4,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 3
      },
      {
        "schema": "public",
        "name": "product_variants",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 14,
        "fk_count": 1,
        "policy_count": 2,
        "trigger_count": 0,
        "index_count": 5
      },
      {
        "schema": "public",
        "name": "products",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 11,
        "fk_count": 1,
        "policy_count": 2,
        "trigger_count": 0,
        "index_count": 5
      },
      {
        "schema": "public",
        "name": "profiles",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 7,
        "fk_count": 1,
        "policy_count": 3,
        "trigger_count": 0,
        "index_count": 2
      },
      {
        "schema": "public",
        "name": "purchased_tickets",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 13,
        "fk_count": 3,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 5
      },
      {
        "schema": "public",
        "name": "reservations",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 10,
        "fk_count": 2,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 4
      },
      {
        "schema": "public",
        "name": "shipments",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 14,
        "fk_count": 1,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 2
      },
      {
        "schema": "public",
        "name": "shipping_settings",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 7,
        "fk_count": 0,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 1
      },
      {
        "schema": "public",
        "name": "shipping_voucher_usage",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 7,
        "fk_count": 3,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 3
      },
      {
        "schema": "public",
        "name": "shipping_vouchers",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 15,
        "fk_count": 0,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 3
      },
      {
        "schema": "public",
        "name": "stage_scans",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 6,
        "fk_count": 2,
        "policy_count": 2,
        "trigger_count": 0,
        "index_count": 4
      },
      {
        "schema": "public",
        "name": "stages",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 10,
        "fk_count": 0,
        "policy_count": 4,
        "trigger_count": 1,
        "index_count": 2
      },
      {
        "schema": "public",
        "name": "stock_reservations",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 8,
        "fk_count": 2,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 3
      },
      {
        "schema": "public",
        "name": "ticket_availabilities",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 10,
        "fk_count": 1,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 3
      },
      {
        "schema": "public",
        "name": "ticket_reviews",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 11,
        "fk_count": 3,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 4
      },
      {
        "schema": "public",
        "name": "tickets",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 12,
        "fk_count": 0,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 2
      },
      {
        "schema": "public",
        "name": "user_addresses",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 16,
        "fk_count": 1,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 2
      },
      {
        "schema": "public",
        "name": "user_id_mapping",
        "rls_enabled": false,
        "rls_forced": false,
        "column_count": 4,
        "fk_count": 1,
        "policy_count": 0,
        "trigger_count": 0,
        "index_count": 1
      },
      {
        "schema": "public",
        "name": "user_role_assignments",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 3,
        "fk_count": 1,
        "policy_count": 1,
        "trigger_count": 0,
        "index_count": 1
      },
      {
        "schema": "public",
        "name": "webhook_logs",
        "rls_enabled": true,
        "rls_forced": false,
        "column_count": 7,
        "fk_count": 0,
        "policy_count": 1,
        "trigger_count": 0,
        "index_count": 1
      }
    ],
    "rls_policies": [
      {
        "tablename": "order_product_items",
        "policyname": "order_product_items_admin_read",
        "cmd": "SELECT",
        "roles": "{authenticated}",
        "qual": "is_admin()",
        "with_check": null
      },
      {
        "tablename": "order_product_items",
        "policyname": "order_product_items_read_own",
        "cmd": "SELECT",
        "roles": "{public}",
        "qual": "(EXISTS ( SELECT 1\\n   FROM order_products op\\n  WHERE ((op.id = order_product_items.order_product_id) AND (op.user_id = auth.uid()))))",
        "with_check": null
      },
      {
        "tablename": "order_products",
        "policyname": "order_products_admin_read",
        "cmd": "SELECT",
        "roles": "{authenticated}",
        "qual": "is_admin()",
        "with_check": null
      },
      {
        "tablename": "order_products",
        "policyname": "order_products_read_own",
        "cmd": "SELECT",
        "roles": "{public}",
        "qual": "(auth.uid() = user_id)",
        "with_check": null
      },
      {
        "tablename": "product_images",
        "policyname": "Auth delete",
        "cmd": "DELETE",
        "roles": "{authenticated}",
        "qual": "true",
        "with_check": null
      },
      {
        "tablename": "product_images",
        "policyname": "Auth insert",
        "cmd": "INSERT",
        "roles": "{authenticated}",
        "qual": null,
        "with_check": "true"
      },
      {
        "tablename": "product_images",
        "policyname": "Auth update",
        "cmd": "UPDATE",
        "roles": "{authenticated}",
        "qual": "true",
        "with_check": null
      },
      {
        "tablename": "product_images",
        "policyname": "Public read",
        "cmd": "SELECT",
        "roles": "{public}",
        "qual": "true",
        "with_check": null
      },
      {
        "tablename": "product_variants",
        "policyname": "product_variants_admin_all",
        "cmd": "ALL",
        "roles": "{public}",
        "qual": "(EXISTS ( SELECT 1\\n   FROM user_role_assignments ura\\n  WHERE ((ura.user_id = auth.uid()) AND (lower(ura.role_name) = 'admin'::text))))",
        "with_check": "(EXISTS ( SELECT 1\\n   FROM user_role_assignments ura\\n  WHERE ((ura.user_id = auth.uid()) AND (lower(ura.role_name) = 'admin'::text))))"
      },
      {
        "tablename": "product_variants",
        "policyname": "product_variants_public_read",
        "cmd": "SELECT",
        "roles": "{public}",
        "qual": "(is_active IS TRUE)",
        "with_check": null
      },
      {
        "tablename": "products",
        "policyname": "products_admin_all",
        "cmd": "ALL",
        "roles": "{public}",
        "qual": "(EXISTS ( SELECT 1\\n   FROM user_role_assignments ura\\n  WHERE ((ura.user_id = auth.uid()) AND (lower(ura.role_name) = 'admin'::text))))",
        "with_check": "(EXISTS ( SELECT 1\\n   FROM user_role_assignments ura\\n  WHERE ((ura.user_id = auth.uid()) AND (lower(ura.role_name) = 'admin'::text))))"
      },
      {
        "tablename": "products",
        "policyname": "products_public_read",
        "cmd": "SELECT",
        "roles": "{public}",
        "qual": "((is_active IS TRUE) AND (deleted_at IS NULL))",
        "with_check": null
      },
      {
        "tablename": "profiles",
        "policyname": "Service role has full access",
        "cmd": "ALL",
        "roles": "{public}",
        "qual": "(auth.role() = 'service_role'::text)",
        "with_check": null
      },
      {
        "tablename": "profiles",
        "policyname": "Users can update their own profile",
        "cmd": "UPDATE",
        "roles": "{public}",
        "qual": "(auth.uid() = id)",
        "with_check": null
      },
      {
        "tablename": "profiles",
        "policyname": "Users can view their own profile",
        "cmd": "SELECT",
        "roles": "{public}",
        "qual": "(auth.uid() = id)",
        "with_check": null
      },
      {
        "tablename": "stage_scans",
        "policyname": "Admins can view all scans",
        "cmd": "SELECT",
        "roles": "{public}",
        "qual": "(EXISTS ( SELECT 1\\n   FROM user_role_assignments\\n  WHERE ((user_role_assignments.user_id = auth.uid()) AND (user_role_assignments.role_name = ANY (ARRAY['admin'::text, 'super_admin'::text])))))",
        "with_check": null
      },
      {
        "tablename": "stage_scans",
        "policyname": "Anyone can create scans",
        "cmd": "INSERT",
        "roles": "{public}",
        "qual": null,
        "with_check": "true"
      },
      {
        "tablename": "stages",
        "policyname": "Only admins can delete stages",
        "cmd": "DELETE",
        "roles": "{public}",
        "qual": "(EXISTS ( SELECT 1\\n   FROM user_role_assignments\\n  WHERE ((user_role_assignments.user_id = auth.uid()) AND (user_role_assignments.role_name = ANY (ARRAY['admin'::text, 'super_admin'::text])))))",
        "with_check": null
      },
      {
        "tablename": "stages",
        "policyname": "Only admins can insert stages",
        "cmd": "INSERT",
        "roles": "{public}",
        "qual": null,
        "with_check": "(EXISTS ( SELECT 1\\n   FROM user_role_assignments\\n  WHERE ((user_role_assignments.user_id = auth.uid()) AND (user_role_assignments.role_name = ANY (ARRAY['admin'::text, 'super_admin'::text])))))"
      },
      {
        "tablename": "stages",
        "policyname": "Only admins can update stages",
        "cmd": "UPDATE",
        "roles": "{public}",
        "qual": "(EXISTS ( SELECT 1\\n   FROM user_role_assignments\\n  WHERE ((user_role_assignments.user_id = auth.uid()) AND (user_role_assignments.role_name = ANY (ARRAY['admin'::text, 'super_admin'::text])))))",
        "with_check": null
      },
      {
        "tablename": "stages",
        "policyname": "Stages are viewable by everyone",
        "cmd": "SELECT",
        "roles": "{public}",
        "qual": "true",
        "with_check": null
      },
      {
        "tablename": "user_role_assignments",
        "policyname": "read own roles",
        "cmd": "SELECT",
        "roles": "{authenticated}",
        "qual": "(user_id = auth.uid())",
        "with_check": null
      },
      {
        "tablename": "webhook_logs",
        "policyname": "admin_read_webhook_logs",
        "cmd": "SELECT",
        "roles": "{public}",
        "qual": "(EXISTS ( SELECT 1\\n   FROM user_role_assignments ura\\n  WHERE ((ura.user_id = auth.uid()) AND (lower(ura.role_name) = 'admin'::text))))",
        "with_check": null
      }
    ],
    "notable_discrepancies": [
      {
        "type": "live_schema_vs_migrations",
        "severity": "warning",
        "object": "public.order_products",
        "issue": "Duplicate FKs on user_id exist in live schema (auth.users and profiles). Not represented in the read migration set."
      }
    ]
  },
  "required_fixes": [
    "Copy supabase/migrations from Spark studio into sparkstage55.",
    "Restructure sparkstage55 Supabase functions to match Spark studio layout (supabase/functions/<slug>/index.ts).",
    "Ensure byte-identical sync for audited DB-related files to pass final validator."
  ]
}
